//
// VTAcknowledgementsViewController.m
//
// Copyright (c) 2013-2015 Vincent Tourraine (http://www.vtourraine.net)
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
// THE SOFTWARE.

#import "VTAcknowledgementsViewController.h"
#import "VTAcknowledgementViewController.h"
#import "VTAcknowledgement.h"

static NSString *const VTDefaultAcknowledgementsPlistName = @"Pods-acknowledgements";
static NSString *const VTDefaultHeaderText                = @"This application makes use of the following third party libraries:";
static NSString *const VTDefaultFooterText                = @"Generated by CocoaPods - http://cocoapods.org";
static NSString *const VTCocoaPodsURLString               = @"http://cocoapods.org";
static NSString *const VTCellIdentifier                   = @"Cell";

static const CGFloat VTLabelMargin = 20;

NSString *const VTHeaderLabelFontKey            = @"VTHeaderLabelFontKey";
NSString *const VTFooterLabelFontKey            = @"VTFooterLabelFontKey";
NSString *const VTHeaderLabelTextColorKey       = @"VTHeaderLabelTextColorKey";
NSString *const VTFooterLabelTextColorKey       = @"VTFooterLabelTextColorKey";
NSString *const VTHeaderLabelTextAlignmentKey   = @"VTHeaderLabelTextAlignmentKey";
NSString *const VTFooterLabelTextAlignmentKey   = @"VTFooterLabelTextAlignmentKey";
NSString *const VTCellTextLabelFontKey          = @"VTCellTextLabelFontKey";
NSString *const VTCellTextLabelColorKey         = @"VTCellTextLabelColorKey";
NSString *const VTCellDetailTextLabelFontKey    = @"VTCellDetailTextLabelFontKey";
NSString *const VTCellDetailTextLabelColorKey   = @"VTCellDetailTextLabelColorKey";
NSString *const VTTextViewFontKey               = @"VTTextViewFontKey";
NSString *const VTTextViewColorKey              = @"VTTextViewColorKey";
NSString *const VTTextViewBackgroundColorKey    = @"VTTextViewBackgroundColorKey";


@interface VTAcknowledgementsViewController ()

@property (nonatomic, copy) UIFont *headerLabelFont;
@property (nonatomic, copy) IBInspectable UIColor *headerLabelTextColor;
@property (nonatomic, assign) NSTextAlignment headerTextAlignment;
@property (nonatomic, copy) UIFont *footerLabelFont;
@property (nonatomic, copy) IBInspectable UIColor *footerLabelTextColor;
@property (nonatomic, assign) NSTextAlignment footerTextAlignment;
@property (nonatomic, copy) UIFont *cellTextLabelFont;
@property (nonatomic, copy) IBInspectable UIColor *cellTextLabelColor;
@property (nonatomic, copy) UIFont *cellDetailTextLabelFont;
@property (nonatomic, copy) IBInspectable UIColor *cellDetailTextLabelColor;
@property (nonatomic, copy) UIFont *textViewFont;
@property (nonatomic, copy) UIColor *textViewColor;
@property (nonatomic, copy) UIColor *textViewBackgroundColor;

+ (NSString *)acknowledgementsPlistPathForName:(NSString *)name;
+ (NSString *)defaultAcknowledgementsPlistPath;
+ (NSString *)localizedStringForKey:(NSString *)key withDefault:(NSString *)defaultString;
+ (NSString *)localizedCocoaPodsFooterText;

- (void)configureHeaderView;
- (void)configureFooterView;
- (CGFloat)heightForLabelWithText:(NSString *)labelText font:(UIFont *)font andWidth:(CGFloat)labelWidth;

- (IBAction)dismissViewController:(id)sender;
- (void)commonInitWithAcknowledgementsPlistPath:(NSString *)acknowledgementsPlistPath;
- (void)openCocoaPodsWebsite:(id)sender;

@end


@implementation VTAcknowledgementsViewController

+ (NSString *)acknowledgementsPlistPathForName:(NSString *)name
{
    return [[NSBundle mainBundle] pathForResource:name ofType:@"plist"];
}

+ (NSString *)defaultAcknowledgementsPlistPath
{
    return [self acknowledgementsPlistPathForName:VTDefaultAcknowledgementsPlistName];
}

+ (instancetype)acknowledgementsViewController
{
    NSString *path = self.defaultAcknowledgementsPlistPath;
    return [[self.class alloc] initWithAcknowledgementsPlistPath:path];
}

+ (instancetype)acknowledgementsViewControllerWithSettings:(NSDictionary *)settings
{
    NSString *path = self.defaultAcknowledgementsPlistPath;
    return [[self.class alloc] initWithAcknowledgementsPlistPath:path settings:settings];
}

- (instancetype)initWithAcknowledgementsPlistPath:(NSString *)acknowledgementsPlistPath
{
    self = [super initWithStyle:UITableViewStyleGrouped];
    if (self) {
        [self commonInitWithAcknowledgementsPlistPath:acknowledgementsPlistPath];
    }
    
    return self;
}

- (instancetype)initWithAcknowledgementsPlistPath:(NSString *)acknowledgementsPlistPath settings:(NSDictionary *)settings
{
    self = [self initWithAcknowledgementsPlistPath:acknowledgementsPlistPath];
    if (self) {
        if (settings) {
            self.headerLabelFont            = settings[VTHeaderLabelFontKey];
            self.headerLabelTextColor       = settings[VTHeaderLabelTextColorKey];
            self.headerTextAlignment        = settings[VTHeaderLabelTextAlignmentKey];
            self.footerLabelFont            = settings[VTFooterLabelFontKey];
            self.footerLabelTextColor       = settings[VTFooterLabelTextColorKey];
            self.footerTextAlignment        = settings[VTFooterLabelTextAlignmentKey];
            self.cellTextLabelFont          = settings[VTCellTextLabelFontKey];
            self.cellTextLabelColor         = settings[VTCellTextLabelColorKey];
            self.cellDetailTextLabelFont    = settings[VTCellDetailTextLabelFontKey];
            self.cellDetailTextLabelColor   = settings[VTCellDetailTextLabelColorKey];
            self.textViewFont               = settings[VTTextViewFontKey];
            self.textViewColor              = settings[VTTextViewColorKey];
            self.textViewBackgroundColor    = settings[VTTextViewBackgroundColorKey];
        }
    }
    
    return self;
}

- (void)awakeFromNib
{
    [super awakeFromNib];

    NSString *path;
    if (self.acknowledgementsPlistName) {
        path = [self.class acknowledgementsPlistPathForName:self.acknowledgementsPlistName];
    }
    else {
        path = self.class.defaultAcknowledgementsPlistPath;
    }

    [self commonInitWithAcknowledgementsPlistPath:path];
}

- (void)commonInitWithAcknowledgementsPlistPath:(NSString *)acknowledgementsPlistPath
{
    self.title = self.class.localizedTitle;
    NSDictionary *root = [NSDictionary dictionaryWithContentsOfFile:acknowledgementsPlistPath];
    NSArray *preferenceSpecifiers = root[@"PreferenceSpecifiers"];
    if (preferenceSpecifiers.count >= 2) {
        NSString *headerText = preferenceSpecifiers.firstObject[@"FooterText"];
        NSString *footerText = preferenceSpecifiers.lastObject[@"FooterText"];

        if ([headerText isEqualToString:VTDefaultHeaderText]) {
            self.headerText = nil;
        }
        else if (![headerText isEqualToString:@""]) {
            self.headerText = headerText;
        }

        if ([footerText isEqualToString:VTDefaultFooterText]) {
            self.footerText = [VTAcknowledgementsViewController localizedCocoaPodsFooterText];
        }
        else if (![footerText isEqualToString:@""]) {
            self.footerText = footerText;
        }

        // Remove the header and footer
        NSRange range = NSMakeRange(1, preferenceSpecifiers.count - 2);
        preferenceSpecifiers = [preferenceSpecifiers subarrayWithRange:range];
    }

    NSMutableArray *acknowledgements = [NSMutableArray array];
    for (NSDictionary *preferenceSpecifier in preferenceSpecifiers) {
        VTAcknowledgement *acknowledgement = [VTAcknowledgement new];
        acknowledgement.title = preferenceSpecifier[@"Title"];
        acknowledgement.text  = preferenceSpecifier[@"FooterText"];
        [acknowledgements addObject:acknowledgement];
    }

    [acknowledgements sortUsingComparator:^NSComparisonResult(VTAcknowledgement *obj1, VTAcknowledgement *obj2) {
        return [obj1.title compare:obj2.title
                           options:kNilOptions
                             range:NSMakeRange(0, obj1.title.length)
                            locale:[NSLocale currentLocale]];
    }];

    self.acknowledgements = acknowledgements;
}


#pragma mark - Localization

+ (NSString *)localizedStringForKey:(NSString *)key withDefault:(NSString *)defaultString
{
    static NSBundle *bundle = nil;
    if (!bundle) {
        NSString *bundlePath = [NSBundle.mainBundle pathForResource:@"VTAcknowledgementsViewController" ofType:@"bundle"];
        bundle = [NSBundle bundleWithPath:bundlePath];

        NSString *language = NSLocale.preferredLanguages.count? NSLocale.preferredLanguages.firstObject: @"en";
        if (![bundle.localizations containsObject:language]) {
            language = [language componentsSeparatedByString:@"-"].firstObject;
        }
        if ([bundle.localizations containsObject:language]) {
            bundlePath = [bundle pathForResource:language ofType:@"lproj"];
        }

        bundle = [NSBundle bundleWithPath:bundlePath] ?: NSBundle.mainBundle;
    }

    defaultString = [bundle localizedStringForKey:key value:defaultString table:nil];
    return [NSBundle.mainBundle localizedStringForKey:key value:defaultString table:nil];
}

+ (NSString *)localizedTitle
{
    return [self localizedStringForKey:@"VTAckAcknowledgements" withDefault:@"Acknowledgements"];
}

+ (NSString *)localizedCocoaPodsFooterText
{
    return [NSString stringWithFormat:@"%@\n%@",
            [self.class localizedStringForKey:@"VTAckGeneratedByCocoaPods" withDefault:@"Generated by CocoaPods"],
            VTCocoaPodsURLString];
}


#pragma mark - View lifecycle

- (void)viewDidLoad
{
    [super viewDidLoad];

    if (self.headerText) {
        [self configureHeaderView];
    }

    if (self.footerText) {
        [self configureFooterView];
    }

    if (self.presentingViewController && self == [self.navigationController.viewControllers firstObject]) {
        self.navigationItem.leftBarButtonItem = [[UIBarButtonItem alloc] initWithBarButtonSystemItem:UIBarButtonSystemItemDone
                                                                                              target:self
                                                                                              action:@selector(dismissViewController:)];
    }
}

- (void)configureHeaderView
{
    UIFont *font = self.headerLabelFont ? self.headerLabelFont : [UIFont systemFontOfSize:12];
    CGFloat labelWidth = CGRectGetWidth(self.view.frame) - 2 * VTLabelMargin;
    CGFloat labelHeight = [self heightForLabelWithText:self.headerText font:font andWidth:labelWidth];

    CGRect labelFrame = CGRectMake(VTLabelMargin, VTLabelMargin, labelWidth, labelHeight);

    UILabel *label = [[UILabel alloc] initWithFrame:labelFrame];
    label.text             = self.headerText;
    label.font             = font;
    label.textColor        = self.headerLabelTextColor ? self.headerLabelTextColor : [UIColor grayColor];
    label.backgroundColor  = [UIColor clearColor];
    label.numberOfLines    = 0;
    label.textAlignment    = self.headerTextAlignment ? self.headerTextAlignment : NSTextAlignmentCenter;
    label.autoresizingMask = (UIViewAutoresizingFlexibleLeftMargin | UIViewAutoresizingFlexibleRightMargin);

    CGRect headerFrame = CGRectMake(0, 0, CGRectGetWidth(self.view.frame), CGRectGetHeight(label.frame) + 2 * VTLabelMargin);
    UIView *headerView = [[UIView alloc] initWithFrame:headerFrame];
    [headerView addSubview:label];
    self.tableView.tableHeaderView = headerView;
}

- (void)configureFooterView
{
    UIFont *font = self.footerLabelFont ? self.footerLabelFont : [UIFont systemFontOfSize:12];
    CGFloat labelWidth = CGRectGetWidth(self.view.frame) - 2 * VTLabelMargin;
    CGFloat labelHeight = [self heightForLabelWithText:self.footerText font:font andWidth:labelWidth];

    CGRect labelFrame = CGRectMake(VTLabelMargin, 0, labelWidth, labelHeight);

    UILabel *label = [[UILabel alloc] initWithFrame:labelFrame];
    label.text             = self.footerText;
    label.font             = font;
    label.textColor        = self.footerLabelTextColor ? self.footerLabelTextColor : [UIColor grayColor];
    label.backgroundColor  = [UIColor clearColor];
    label.numberOfLines    = 0;
    label.textAlignment    = self.footerTextAlignment ? self.footerTextAlignment : NSTextAlignmentCenter;
    label.autoresizingMask = (UIViewAutoresizingFlexibleLeftMargin | UIViewAutoresizingFlexibleRightMargin);
    label.userInteractionEnabled = YES;

    if ([self.footerText rangeOfString:[NSURL URLWithString:VTCocoaPodsURLString].host].location != NSNotFound) {
        UITapGestureRecognizer *tapGestureRecognizer = [[UITapGestureRecognizer alloc] initWithTarget:self action:@selector(openCocoaPodsWebsite:)];
        [label addGestureRecognizer:tapGestureRecognizer];
    }

    CGRect footerFrame = CGRectMake(0, 0, CGRectGetWidth(label.frame), CGRectGetHeight(label.frame));
    UIView *footerView = [[UIView alloc] initWithFrame:footerFrame];
    footerView.userInteractionEnabled = YES;
    [footerView addSubview:label];
    label.frame = CGRectMake(0, 0, CGRectGetWidth(label.frame), CGRectGetHeight(label.frame));
    self.tableView.tableFooterView = footerView;
}

- (CGFloat)heightForLabelWithText:(NSString *)labelText font:(UIFont *)font andWidth:(CGFloat)labelWidth
{
    CGFloat labelHeight;

    if ([labelText respondsToSelector:@selector(boundingRectWithSize:options:attributes:context:)]) {
        NSStringDrawingOptions options = (NSLineBreakByWordWrapping | NSStringDrawingUsesLineFragmentOrigin);
        CGRect labelBounds = [labelText boundingRectWithSize:CGSizeMake(labelWidth, CGFLOAT_MAX)
                                                     options:options
                                                  attributes:@{NSFontAttributeName: font}
                                                     context:nil];
        labelHeight = CGRectGetHeight(labelBounds);
    }
    else {
#pragma GCC diagnostic push
#pragma GCC diagnostic ignored "-Wdeprecated-declarations"
        CGSize size = [labelText sizeWithFont:font constrainedToSize:(CGSize){labelWidth, CGFLOAT_MAX}];
#pragma GCC diagnostic pop
        labelHeight = size.height;
    }

    return ceilf(labelHeight);
}

- (void)viewWillAppear:(BOOL)animated
{
    [super viewWillAppear:animated];

    [self.tableView deselectRowAtIndexPath:self.tableView.indexPathForSelectedRow
                                  animated:animated];
}

- (void)viewDidAppear:(BOOL)animated
{
    [super viewDidAppear:animated];

    if (self.acknowledgements.count == 0) {
        NSLog(@"** VTAcknowledgementsViewController Warning **");
        NSLog(@"No acknowledgements found.");
        NSLog(@"This probably means that you didn’t import the `Pods-acknowledgements.plist` to your main target.");
        NSLog(@"Please take a look at https://github.com/vtourraine/VTAcknowledgementsViewController for instructions.");
    }
}

- (void)didRotateFromInterfaceOrientation:(UIInterfaceOrientation)fromInterfaceOrientation
{
    [super didRotateFromInterfaceOrientation:fromInterfaceOrientation];

    if (self.headerText) {
        [self configureHeaderView];
    }

    if (self.footerText) {
        [self configureFooterView];
    }
}


#pragma mark - Actions

- (void)openCocoaPodsWebsite:(id)sender
{
    NSURL *URL = [NSURL URLWithString:VTCocoaPodsURLString];
    [[UIApplication sharedApplication] openURL:URL];
}

- (IBAction)dismissViewController:(id)sender
{
    [self dismissViewControllerAnimated:YES completion:nil];
}


#pragma mark - Table view data source

- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section
{
    return self.acknowledgements.count;
}

- (CGFloat)tableView:(UITableView *)tableView estimatedHeightForRowAtIndexPath:(NSIndexPath *)indexPath
{
    return UITableViewAutomaticDimension;
}

- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath
{
    UITableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:VTCellIdentifier];
    if (!cell) {
        cell = [[UITableViewCell alloc] initWithStyle:UITableViewCellStyleSubtitle reuseIdentifier:VTCellIdentifier];
    }
    if (self.cellTextLabelFont) {
        cell.textLabel.font = self.cellTextLabelFont;
    }
    if (self.cellTextLabelColor) {
        cell.textLabel.textColor = self.cellTextLabelColor;
    }
    if (self.cellDetailTextLabelFont) {
        cell.detailTextLabel.font = self.cellDetailTextLabelFont;
    }
    if (self.cellDetailTextLabelColor) {
        cell.detailTextLabel.textColor = self.cellDetailTextLabelColor;
    }
    
    VTAcknowledgement *acknowledgement = self.acknowledgements[indexPath.row];
    cell.textLabel.text = acknowledgement.title;
    cell.detailTextLabel.text = acknowledgement.subtitle;
    cell.accessoryType  = UITableViewCellAccessoryDisclosureIndicator;

    return cell;
}


#pragma mark - Table view delegate

- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath
{
    VTAcknowledgement *acknowledgement = self.acknowledgements[indexPath.row];
    VTAcknowledgementViewController *viewController = [[VTAcknowledgementViewController alloc] initWithTitle:acknowledgement.title text:acknowledgement.text];
    viewController.textView.font = self.textViewFont;
    viewController.textView.textColor = self.textViewColor;
    
    if (self.textViewBackgroundColor) {
        viewController.view.backgroundColor = self.textViewBackgroundColor;
    }
    
    [self.navigationController pushViewController:viewController animated:YES];
}

@end
